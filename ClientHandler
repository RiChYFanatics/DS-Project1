package com.company;

import java.io.*;
import java.net.Socket;
import java.lang.*;

class ClientHandler extends Thread {
    final DataInputStream input;
    final DataOutputStream output;
    final Socket connection;
    public Db db;
    public Player player;
    public Team teamcreated;
    public ObjectOutputStream oos;
    double teamtime;

    public ClientHandler(Socket connection, DataInputStream input, DataOutputStream output, Db db, Player player) {
        this.connection = connection;
        this.input = input;
        this.output = output;
        this.db = db;
        this.player = player;
    }

    public void run() {
        try {
            OutputStream os = connection.getOutputStream();
            oos = new ObjectOutputStream(os);
        } catch (IOException e) {
            e.printStackTrace();
        }

        new BufferedReader(new InputStreamReader(System.in));
        boolean logged_in = false;
        boolean cont = true;
        String text = "According to all laws of aviation, there is no way a bee should be able to fly.";

        try {
            this.output.writeUTF("Welcome\n");

            label50:
            while(true) {
                while(true) {
                    if (!cont) {
                        break label50;
                    }
                    this.output.writeUTF("Please choose one of the functionalities:\n1.Register     2.Log In     3.Join Team/Play");
                    this.output.flush();
                    int func = this.input.readInt();
                    switch(func) {
                        case 1:
                            String request_username = "Please enter your desired username: ";
                            this.output.writeUTF(request_username);
                            this.output.flush();
                            String username = this.input.readUTF();
                            String request_password = "Please enter your desired password: ";
                            this.output.writeUTF(request_password);
                            this.output.flush();
                            String password = this.input.readUTF();
                            this.db.registered.put(username, password);
                            this.output.writeUTF("You are now registered! Please proceed to login in order to play the game. ");
                            this.output.flush();
                            break;
                        case 2:
                            if (!logged_in) {
                                this.output.writeUTF("n");
                                this.output.writeUTF("Enter your username: ");
                                this.output.flush();
                                String given_username = this.input.readUTF();
                                this.output.writeUTF("Enter your password: ");
                                this.output.flush();
                                String given_password = this.input.readUTF();
                                if (this.db.registered.containsKey(given_username)) {
                                    String upass = (String)this.db.registered.get(given_username);
                                    if (upass.equals(given_password)) {
                                        this.output.writeUTF("You are now logged in, and may continue to play the game.");
                                        this.output.flush();
                                        logged_in = true;
                                    } else {
                                        this.output.writeUTF("Wrong credentials. Please try to login again, or register if you have not done so already!");
                                    }
                                } else {
                                    output.writeUTF("Wrong credentials. Please try to login again, or register if you have not done so already!");
                                }
                                break;
                            } else {
                                this.output.writeUTF("y");
                            }
                        case 3:
                            if (!logged_in) {
                                this.output.writeUTF("n");
                                break;
                            } else {
                                this.output.writeUTF("y");
                                this.output.flush();
                                this.output.writeUTF("Waiting for another player to join");
                                this.output.flush();
                                this.db.quePlayer(this.player);
                                teamcreated = this.db.createTeam();
                                this.output.writeUTF("Team Created!");
                                this.output.flush();
                                Thread.sleep(1000L);
                                this.db.Listindex();
                                if (this.input.readUTF().equals("y")) {
                                    this.player.ready = true;
                                    teamcreated.playersReady();
                                    this.output.writeUTF("Game Starting in:");
                                }

                                this.output.writeUTF("3");
                                this.output.flush();
                                Thread.sleep(1000L);
                                this.output.writeUTF("2");
                                this.output.flush();
                                Thread.sleep(1000L);
                                this.output.writeUTF("1");
                                this.output.flush();
                                Thread.sleep(1000L);
                                this.output.writeUTF("GO!");
                                this.output.flush();
                                if (this.teamcreated.goFirst(player)) {
                                    this.output.writeUTF("y");
                                    this.output.flush();
                                    this.output.writeUTF(text);
                                    this.output.flush();
                                    double start1 = System.currentTimeMillis();
                                    String text1 = input.readUTF();
                                    double end1 = System.currentTimeMillis();
                                    if (text1.equals(text)) {
                                        this.teamcreated.p1.correct = true;
                                    }
                                    double time1 = end1 - start1;
                                    double time1s = time1 / 1000;
                                    this.db.playerTime(time1s);
                                    this.teamcreated.p1.finished = true;
                                    while (!(this.teamcreated.p2.finished)) {
                                        Thread.sleep(1000L);
                                    }
                                }
                                else {
                                    this.output.writeUTF("n");
                                    this.output.flush();
                                    this.output.writeUTF("n");
                                    this.output.flush();
                                    while (this.teamcreated.p1.finished == false) {
                                        Thread.sleep(500L);
                                        if (this.teamcreated.p1.finished == true) {
                                            break;
                                        }
                                    }
                                    this.output.writeUTF(text);
                                    this.output.flush();
                                    double start2 = System.currentTimeMillis();
                                    String text2 = input.readUTF();
                                    double end2 = System.currentTimeMillis();
                                    if (text2.equals(text)) {
                                        this.teamcreated.p2.correct = true;
                                    }
                                    double time2 = end2 - start2;
                                    double time2s = time2 / 1000;
                                    this.db.playerTime(time2s);
                                    this.teamcreated.p2.finished = true;

                                }

                                if (this.teamcreated.p1.correct && this.teamcreated.p2.correct) {
                                    if (!(this.teamcreated.goFirst(player))) {
                                        teamtime = this.db.teamTime();
                                        this.db.recordBoard.add(teamtime);
                                        this.db.sortBoard();
                                    } else {
                                        Thread.sleep(2000L);
                                        teamtime = this.db.teamTime();
                                        this.db.removeTime(); //removes time from temporary list
                                    }
                                    this.oos.writeObject("Game Finished! \nYour team's time is: " + teamtime + " seconds." + "\nLeaderboard from all games: " + this.db.recordBoard);
                                    this.oos.flush();
                                    if (teamtime == this.db.recordBoard.get(0)) {
                                        output.writeUTF("Congratulations, your time is the new record!\nMaybe try beating the record again?");
                                    } else {
                                        output.writeUTF("Thanks for playing!\n You didnt get the first place,but you can try beating the current record with another game. ");
                                        output.flush(); break;
                                    }
                                }
                                else {
                                    this.oos.writeObject(("The text submitted was not correct, and thus was not counted as a result \nYou may start a new game."));
                                    this.oos.flush(); break;
                                }
                            }
                        default:
                            System.out.println("User entered invalid function");
                    }
                }
            }
        } catch (InterruptedException | IOException var16) {
            System.out.println("Error");
        }

        try {
            this.input.close();
            this.output.close();
            this.connection.close();
        } catch (IOException var15) {
            System.out.println("User disconnected");
        }

    }
}
